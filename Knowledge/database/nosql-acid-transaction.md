# NoSQL ä¸ºä»€ä¹ˆ ACID å’Œäº‹åŠ¡æ”¯æŒä¸å¤Ÿå¥½ï¼Ÿ

> å‰ç«¯è§†è§’ç†è§£ NoSQL çš„æƒè¡¡å–èˆ

## ç›®å½•
1. [ä»€ä¹ˆæ˜¯ ACIDï¼Ÿ](#ä»€ä¹ˆæ˜¯-acid)
2. [ä¸ºä»€ä¹ˆ NoSQL ä¸æ”¯æŒå®Œæ•´ ACIDï¼Ÿ](#ä¸ºä»€ä¹ˆ-nosql-ä¸æ”¯æŒå®Œæ•´-acid)
3. [NoSQL çš„æƒè¡¡ï¼šCAP å®šç†](#nosql-çš„æƒè¡¡cap-å®šç†)
4. [å®é™…å½±å“å’Œè§£å†³æ–¹æ¡ˆ](#å®é™…å½±å“å’Œè§£å†³æ–¹æ¡ˆ)

---

## ä»€ä¹ˆæ˜¯ ACIDï¼Ÿ

ACID æ˜¯æ•°æ®åº“äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§ï¼Œä¿è¯æ•°æ®çš„å¯é æ€§ã€‚

### å‰ç«¯ç±»æ¯”ï¼šç½‘è´­ä¸‹å•

æƒ³è±¡ä½ åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ï¼Œä»˜æ¬¾çš„è¿‡ç¨‹ï¼š

```javascript
// ç½‘è´­ä¸‹å•æµç¨‹
async function checkout() {
  // 1. æ‰£å‡åº“å­˜
  await reduceStock(productId, 1);
  
  // 2. æ‰£æ¬¾
  await deductMoney(userId, 100);
  
  // 3. åˆ›å»ºè®¢å•
  await createOrder(userId, productId);
  
  // 4. å‘é€é€šçŸ¥
  await sendNotification(userId);
}
```

**é—®é¢˜**ï¼šå¦‚æœç¬¬ 2 æ­¥æ‰£æ¬¾å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ
- åº“å­˜å·²ç»æ‰£äº†
- ä½†é’±æ²¡æ‰£
- è®¢å•æ²¡åˆ›å»º

è¿™å°±ä¹±å¥—äº†ï¼ACID å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

---

### A - Atomicityï¼ˆåŸå­æ€§ï¼‰

**å®šä¹‰**ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸å­˜åœ¨"éƒ¨åˆ†æˆåŠŸ"ã€‚

**å‰ç«¯ç±»æ¯”**ï¼š
```javascript
// å°±åƒ Promise.all()
Promise.all([
  reduceStock(),
  deductMoney(),
  createOrder()
])
.then(() => {
  console.log('å…¨éƒ¨æˆåŠŸ');
})
.catch(() => {
  console.log('å…¨éƒ¨å›æ»š');
  // å¦‚æœä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œå…¶ä»–çš„ä¹Ÿè¦æ’¤é”€
});
```

**å…³ç³»å‹æ•°æ®åº“ï¼ˆMySQL/PostgreSQLï¼‰**ï¼š
```sql
BEGIN;  -- å¼€å§‹äº‹åŠ¡

UPDATE products SET stock = stock - 1 WHERE id = 1;
UPDATE users SET balance = balance - 100 WHERE id = 1;
INSERT INTO orders (user_id, product_id) VALUES (1, 1);

COMMIT;  -- å…¨éƒ¨æˆåŠŸæ‰æäº¤

-- å¦‚æœä¸­é—´ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œè‡ªåŠ¨ ROLLBACKï¼ˆå›æ»šï¼‰
```

**NoSQLï¼ˆMongoDBï¼‰**ï¼š
```javascript
// MongoDB 4.0 ä¹‹å‰ï¼šä¸æ”¯æŒå¤šæ–‡æ¡£äº‹åŠ¡
// åªèƒ½ä¿è¯å•ä¸ªæ–‡æ¡£çš„åŸå­æ€§

// âŒ è¿™æ ·ä¸æ˜¯åŸå­çš„
await db.products.updateOne({ _id: 1 }, { $inc: { stock: -1 } });
await db.users.updateOne({ _id: 1 }, { $inc: { balance: -100 } });
await db.orders.insertOne({ userId: 1, productId: 1 });
// å¦‚æœç¬¬äºŒæ­¥å¤±è´¥ï¼Œç¬¬ä¸€æ­¥ä¸ä¼šå›æ»šï¼

// âœ… MongoDB 4.0+ æ”¯æŒäº‹åŠ¡ï¼Œä½†æ€§èƒ½è¾ƒå·®
const session = client.startSession();
session.startTransaction();
try {
  await db.products.updateOne({ _id: 1 }, { $inc: { stock: -1 } }, { session });
  await db.users.updateOne({ _id: 1 }, { $inc: { balance: -100 } }, { session });
  await db.orders.insertOne({ userId: 1, productId: 1 }, { session });
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
}
```

---

### C - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰

**å®šä¹‰**ï¼šæ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚

**å‰ç«¯ç±»æ¯”**ï¼š
```javascript
// å°±åƒ React çš„çŠ¶æ€æ›´æ–°
// çŠ¶æ€è¦ä¹ˆæ˜¯æ—§çš„ï¼Œè¦ä¹ˆæ˜¯æ–°çš„ï¼Œä¸ä¼šå‡ºç°"ä¸­é—´çŠ¶æ€"

const [count, setCount] = useState(0);

// âœ… ä¸€è‡´ï¼šcount è¦ä¹ˆæ˜¯ 0ï¼Œè¦ä¹ˆæ˜¯ 1
setCount(1);

// âŒ ä¸ä¸€è‡´ï¼šcount ä¸ä¼šå‡ºç° 0.5 è¿™ç§ä¸­é—´å€¼
```

**ä¾‹å­ï¼šé“¶è¡Œè½¬è´¦**

```javascript
// è½¬è´¦å‰ï¼šA æœ‰ 1000ï¼ŒB æœ‰ 500ï¼Œæ€»é¢ 1500
// è½¬è´¦ï¼šA è½¬ 100 ç»™ B
// è½¬è´¦åï¼šA æœ‰ 900ï¼ŒB æœ‰ 600ï¼Œæ€»é¢è¿˜æ˜¯ 1500

// ä¸€è‡´æ€§è§„åˆ™ï¼šæ€»é‡‘é¢ä¸å˜
```

**å…³ç³»å‹æ•°æ®åº“**ï¼š
```sql
-- æœ‰çº¦æŸä¿è¯ä¸€è‡´æ€§
CREATE TABLE accounts (
  id INT PRIMARY KEY,
  balance DECIMAL(10,2) CHECK (balance >= 0)  -- ä½™é¢ä¸èƒ½ä¸ºè´Ÿ
);

-- è½¬è´¦
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- A è´¦æˆ·
UPDATE accounts SET balance = balance + 100 WHERE id = 2;  -- B è´¦æˆ·
COMMIT;

-- å¦‚æœ A è´¦æˆ·ä½™é¢ä¸è¶³ï¼ŒCHECK çº¦æŸä¼šé˜»æ­¢æ“ä½œ
```

**NoSQL**ï¼š
```javascript
// MongoDB æ²¡æœ‰çº¦æŸæ£€æŸ¥
// éœ€è¦åœ¨åº”ç”¨å±‚ä¿è¯

// âŒ å¯èƒ½å‡ºç°è´Ÿä½™é¢
await db.accounts.updateOne(
  { _id: 1 },
  { $inc: { balance: -100 } }
);
// å³ä½¿ä½™é¢ä¸è¶³ï¼Œä¹Ÿä¼šæ‰§è¡Œï¼

// âœ… éœ€è¦æ‰‹åŠ¨æ£€æŸ¥
const account = await db.accounts.findOne({ _id: 1 });
if (account.balance >= 100) {
  await db.accounts.updateOne(
    { _id: 1 },
    { $inc: { balance: -100 } }
  );
} else {
  throw new Error('ä½™é¢ä¸è¶³');
}
```

---

### I - Isolationï¼ˆéš”ç¦»æ€§ï¼‰

**å®šä¹‰**ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œäº’ä¸å¹²æ‰°ã€‚

**å‰ç«¯ç±»æ¯”**ï¼š
```javascript
// å°±åƒä¸¤ä¸ªç”¨æˆ·åŒæ—¶æ“ä½œ
// ç”¨æˆ· A å’Œç”¨æˆ· B åŒæ—¶ä¹°æœ€åä¸€ä»¶å•†å“

// æ²¡æœ‰éš”ç¦»æ€§ï¼š
// 1. A æŸ¥è¯¢åº“å­˜ï¼š1 ä»¶
// 2. B æŸ¥è¯¢åº“å­˜ï¼š1 ä»¶
// 3. A è´­ä¹°æˆåŠŸï¼Œåº“å­˜ = 0
// 4. B è´­ä¹°æˆåŠŸï¼Œåº“å­˜ = -1  âŒ è¶…å–äº†ï¼

// æœ‰éš”ç¦»æ€§ï¼š
// 1. A æŸ¥è¯¢å¹¶é”å®šåº“å­˜
// 2. B æŸ¥è¯¢ï¼Œç­‰å¾… A å®Œæˆ
// 3. A è´­ä¹°æˆåŠŸï¼Œåº“å­˜ = 0
// 4. B æŸ¥è¯¢ï¼Œåº“å­˜ = 0ï¼Œè´­ä¹°å¤±è´¥ âœ…
```

**å…³ç³»å‹æ•°æ®åº“ï¼ˆéš”ç¦»çº§åˆ«ï¼‰**ï¼š

```sql
-- PostgreSQL é»˜è®¤ï¼šREAD COMMITTEDï¼ˆè¯»å·²æäº¤ï¼‰
-- å¯ä»¥è®¾ç½®æ›´é«˜çš„éš”ç¦»çº§åˆ«

-- 1. READ UNCOMMITTEDï¼ˆè¯»æœªæäº¤ï¼‰- æœ€ä½
-- å¯èƒ½è¯»åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ï¼ˆè„è¯»ï¼‰

-- 2. READ COMMITTEDï¼ˆè¯»å·²æäº¤ï¼‰- å¸¸ç”¨
-- åªèƒ½è¯»åˆ°å·²æäº¤çš„æ•°æ®

-- 3. REPEATABLE READï¼ˆå¯é‡å¤è¯»ï¼‰- MySQL é»˜è®¤
-- åŒä¸€äº‹åŠ¡å†…å¤šæ¬¡è¯»å–ç»“æœä¸€è‡´

-- 4. SERIALIZABLEï¼ˆä¸²è¡ŒåŒ–ï¼‰- æœ€é«˜
-- å®Œå…¨éš”ç¦»ï¼Œå°±åƒä¸²è¡Œæ‰§è¡Œ

-- ç¤ºä¾‹ï¼šé˜²æ­¢è¶…å–
BEGIN;
SELECT stock FROM products WHERE id = 1 FOR UPDATE;  -- é”å®šè¡Œ
-- å…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…
UPDATE products SET stock = stock - 1 WHERE id = 1;
COMMIT;
```

**NoSQL**ï¼š
```javascript
// MongoDB æ²¡æœ‰é”æœºåˆ¶ï¼ˆ4.0 ä¹‹å‰ï¼‰
// å®¹æ˜“å‡ºç°å¹¶å‘é—®é¢˜

// âŒ æ²¡æœ‰éš”ç¦»æ€§
const product = await db.products.findOne({ _id: 1 });
if (product.stock > 0) {
  // è¿™é‡Œå¯èƒ½æœ‰å…¶ä»–ç”¨æˆ·ä¹Ÿåœ¨æ“ä½œ
  await db.products.updateOne(
    { _id: 1 },
    { $inc: { stock: -1 } }
  );
}

// âœ… ä½¿ç”¨åŸå­æ“ä½œ
await db.products.updateOne(
  { _id: 1, stock: { $gt: 0 } },  // æ¡ä»¶ï¼šåº“å­˜ > 0
  { $inc: { stock: -1 } }
);
// å¦‚æœåº“å­˜ä¸è¶³ï¼Œæ›´æ–°å¤±è´¥
```

---

### D - Durabilityï¼ˆæŒä¹…æ€§ï¼‰

**å®šä¹‰**ï¼šäº‹åŠ¡æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

**å‰ç«¯ç±»æ¯”**ï¼š
```javascript
// å°±åƒ localStorage
localStorage.setItem('user', JSON.stringify(user));
// å³ä½¿å…³é—­æµè§ˆå™¨ï¼Œæ•°æ®è¿˜åœ¨

// å¦‚æœåªå­˜åœ¨å†…å­˜
let user = { name: 'å¼ ä¸‰' };
// åˆ·æ–°é¡µé¢ï¼Œæ•°æ®å°±æ²¡äº†
```

**å…³ç³»å‹æ•°æ®åº“**ï¼š
```sql
-- ä½¿ç”¨ WALï¼ˆWrite-Ahead Loggingï¼‰
-- å…ˆå†™æ—¥å¿—ï¼Œå†å†™æ•°æ®

COMMIT;  -- æäº¤åï¼Œæ•°æ®ä¸€å®šä¼šä¿å­˜
-- å³ä½¿æ­¤æ—¶æ–­ç”µï¼Œé‡å¯åä¼šä»æ—¥å¿—æ¢å¤
```

**NoSQL**ï¼š
```javascript
// MongoDB é»˜è®¤é…ç½®ï¼šå¯èƒ½ä¸¢å¤±æ•°æ®

// å†™æ“ä½œ
await db.users.insertOne({ name: 'å¼ ä¸‰' });
// æ•°æ®å…ˆå†™å…¥å†…å­˜ï¼Œæ¯ 60 ç§’åˆ·ç›˜ä¸€æ¬¡
// å¦‚æœ 30 ç§’æ—¶æ–­ç”µï¼Œæ•°æ®ä¸¢å¤±ï¼

// âœ… è®¾ç½® writeConcern ä¿è¯æŒä¹…æ€§
await db.users.insertOne(
  { name: 'å¼ ä¸‰' },
  { writeConcern: { w: 'majority', j: true } }
);
// w: 'majority' - å†™å…¥å¤§å¤šæ•°èŠ‚ç‚¹
// j: true - å†™å…¥æ—¥å¿—
// ä½†æ€§èƒ½ä¼šä¸‹é™
```

---

## ä¸ºä»€ä¹ˆ NoSQL ä¸æ”¯æŒå®Œæ•´ ACIDï¼Ÿ

### æ ¸å¿ƒåŸå› ï¼šè®¾è®¡ç›®æ ‡ä¸åŒ

**å…³ç³»å‹æ•°æ®åº“çš„ç›®æ ‡**ï¼š
- æ•°æ®å‡†ç¡®æ€§ç¬¬ä¸€
- é€‚åˆé‡‘èã€ç”µå•†ç­‰å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯

**NoSQL çš„ç›®æ ‡**ï¼š
- æ€§èƒ½å’Œæ‰©å±•æ€§ç¬¬ä¸€
- é€‚åˆç¤¾äº¤ç½‘ç»œã€æ—¥å¿—ã€åˆ†æç­‰å¯¹æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯

### å…·ä½“åŸå› 

#### 1. åˆ†å¸ƒå¼æ¶æ„

**å…³ç³»å‹æ•°æ®åº“**ï¼š
```
å•æœºæˆ–ä¸»ä»
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL  â”‚ â† æ‰€æœ‰æ•°æ®åœ¨ä¸€èµ·ï¼Œå®¹æ˜“ä¿è¯ ACID
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**NoSQL**ï¼š
```
åˆ†å¸ƒå¼é›†ç¾¤
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚èŠ‚ç‚¹1 â”‚  â”‚èŠ‚ç‚¹2â”‚  â”‚èŠ‚ç‚¹3 â”‚ â† æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**ï¼š
```javascript
// æ•°æ®åˆ†æ•£åœ¨ 3 ä¸ªèŠ‚ç‚¹
// ç”¨æˆ· A åœ¨èŠ‚ç‚¹ 1
// ç”¨æˆ· B åœ¨èŠ‚ç‚¹ 2
// è®¢å•åœ¨èŠ‚ç‚¹ 3

// è½¬è´¦æ“ä½œéœ€è¦è·¨ 3 ä¸ªèŠ‚ç‚¹
// 1. èŠ‚ç‚¹ 1ï¼šæ‰£ A çš„é’±
// 2. èŠ‚ç‚¹ 2ï¼šåŠ  B çš„é’±
// 3. èŠ‚ç‚¹ 3ï¼šåˆ›å»ºè®¢å•

// å¦‚æœèŠ‚ç‚¹ 2 å¤±è´¥äº†ï¼Œæ€ä¹ˆå›æ»šèŠ‚ç‚¹ 1ï¼Ÿ
// ç½‘ç»œå»¶è¿Ÿã€èŠ‚ç‚¹æ•…éšœéƒ½ä¼šå¯¼è‡´é—®é¢˜
```

#### 2. æ€§èƒ½æƒè¡¡

**ACID çš„ä»£ä»·**ï¼š
```javascript
// å…³ç³»å‹æ•°æ®åº“ï¼šä¿è¯ ACID
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;

// éœ€è¦ï¼š
// 1. åŠ é”ï¼ˆå…¶ä»–æ“ä½œè¦ç­‰å¾…ï¼‰
// 2. å†™æ—¥å¿—ï¼ˆé¢å¤– I/Oï¼‰
// 3. ä¸¤é˜¶æ®µæäº¤ï¼ˆåˆ†å¸ƒå¼ç¯å¢ƒï¼‰
// ç»“æœï¼šæ…¢ï¼Œä½†å‡†ç¡®

// NoSQLï¼šç‰ºç‰² ACID æ¢æ€§èƒ½
await db.accounts.updateOne({ _id: 1 }, { $inc: { balance: -100 } });
await db.accounts.updateOne({ _id: 2 }, { $inc: { balance: 100 } });

// ä¸éœ€è¦ï¼š
// 1. ä¸åŠ é”ï¼ˆå¹¶å‘é«˜ï¼‰
// 2. å¼‚æ­¥å†™å…¥ï¼ˆå¿«ï¼‰
// 3. æœ€ç»ˆä¸€è‡´ï¼ˆå¯èƒ½çŸ­æš‚ä¸ä¸€è‡´ï¼‰
// ç»“æœï¼šå¿«ï¼Œä½†å¯èƒ½ä¸å‡†ç¡®
```

#### 3. æ•°æ®æ¨¡å‹

**å…³ç³»å‹**ï¼š
```sql
-- è§„èŒƒåŒ–è®¾è®¡ï¼Œæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªè¡¨
-- éœ€è¦ JOINï¼Œéœ€è¦äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§

CREATE TABLE users (id, name);
CREATE TABLE orders (id, user_id, amount);
CREATE TABLE order_items (order_id, product_id, quantity);

-- åˆ›å»ºè®¢å•éœ€è¦æ“ä½œ 3 ä¸ªè¡¨
BEGIN;
INSERT INTO orders ...;
INSERT INTO order_items ...;
UPDATE users ...;
COMMIT;
```

**NoSQL**ï¼š
```javascript
// åµŒå…¥å¼è®¾è®¡ï¼Œæ•°æ®åœ¨ä¸€ä¸ªæ–‡æ¡£
// å•æ–‡æ¡£æ“ä½œæ˜¯åŸå­çš„ï¼Œä¸éœ€è¦äº‹åŠ¡

{
  _id: 1,
  name: "å¼ ä¸‰",
  orders: [
    {
      id: 101,
      amount: 100,
      items: [
        { productId: 1, quantity: 2 }
      ]
    }
  ]
}

// åˆ›å»ºè®¢å•åªéœ€è¦æ›´æ–°ä¸€ä¸ªæ–‡æ¡£
await db.users.updateOne(
  { _id: 1 },
  { $push: { orders: newOrder } }
);
// å•æ–‡æ¡£æ“ä½œæ˜¯åŸå­çš„ï¼
```

---

## NoSQL çš„æƒè¡¡ï¼šCAP å®šç†

CAP å®šç†è¯´ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½åŒæ—¶æ»¡è¶³ä¸‰ä¸ªç‰¹æ€§ä¸­çš„ä¸¤ä¸ªã€‚

### CAP ä¸‰è¦ç´ 

**C - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**ï¼š
- æ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°çš„æ•°æ®ä¸€è‡´

**A - Availabilityï¼ˆå¯ç”¨æ€§ï¼‰**ï¼š
- ç³»ç»Ÿä¸€ç›´å¯ä»¥å“åº”è¯·æ±‚

**P - Partition Toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰**ï¼š
- ç½‘ç»œæ•…éšœæ—¶ç³»ç»Ÿä»èƒ½å·¥ä½œ

### å‰ç«¯ç±»æ¯”

æƒ³è±¡ä½ å’Œæœ‹å‹åœ¨ä¸‰ä¸ªåŸå¸‚ï¼ˆåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ï¼‰åŒæ—¶ç¼–è¾‘ä¸€ä¸ªå…±äº«æ–‡æ¡£ï¼š

**CAï¼ˆä¸€è‡´æ€§ + å¯ç”¨æ€§ï¼‰**ï¼š
```javascript
// å°±åƒ Google Docs
// æ‰€æœ‰äººçœ‹åˆ°çš„å†…å®¹ä¸€è‡´
// ç³»ç»Ÿä¸€ç›´å¯ç”¨
// ä½†ï¼šå¦‚æœç½‘ç»œæ–­äº†ï¼ˆPï¼‰ï¼Œå°±ä¸èƒ½å·¥ä½œäº†
```

**CPï¼ˆä¸€è‡´æ€§ + åˆ†åŒºå®¹é”™æ€§ï¼‰**ï¼š
```javascript
// å°±åƒé“¶è¡Œç³»ç»Ÿ
// æ•°æ®å¿…é¡»ä¸€è‡´
// ç½‘ç»œæ•…éšœæ—¶ä»èƒ½å·¥ä½œ
// ä½†ï¼šå¯èƒ½æš‚æ—¶ä¸å¯ç”¨ï¼ˆç»´æŠ¤ä¸­ï¼‰
```

**APï¼ˆå¯ç”¨æ€§ + åˆ†åŒºå®¹é”™æ€§ï¼‰**ï¼š
```javascript
// å°±åƒç¤¾äº¤ç½‘ç»œ
// ç³»ç»Ÿä¸€ç›´å¯ç”¨
// ç½‘ç»œæ•…éšœæ—¶ä»èƒ½å·¥ä½œ
// ä½†ï¼šå¯èƒ½çŸ­æš‚ä¸ä¸€è‡´ï¼ˆæœ‹å‹åœˆå»¶è¿Ÿï¼‰
```

### NoSQL çš„é€‰æ‹©

**å¤§å¤šæ•° NoSQL é€‰æ‹© AP**ï¼š
```javascript
// MongoDBã€Cassandra ç­‰é€‰æ‹© AP
// ä¼˜å…ˆä¿è¯ï¼š
// 1. ç³»ç»Ÿä¸€ç›´å¯ç”¨ï¼ˆAï¼‰
// 2. ç½‘ç»œæ•…éšœæ—¶ä»èƒ½å·¥ä½œï¼ˆPï¼‰
// ç‰ºç‰²ï¼š
// 3. å¼ºä¸€è‡´æ€§ï¼ˆCï¼‰â†’ æœ€ç»ˆä¸€è‡´æ€§

// ä¾‹å­ï¼šæœ‹å‹åœˆç‚¹èµ
// ä½ ç‚¹èµåï¼Œå¯èƒ½æœ‹å‹ 1 ç§’åæ‰çœ‹åˆ°
// ä½†ç³»ç»Ÿä¸ä¼šå› æ­¤åœæ­¢æœåŠ¡
```

**å…³ç³»å‹æ•°æ®åº“é€‰æ‹© CA**ï¼š
```sql
-- MySQLã€PostgreSQL é€‰æ‹© CA
-- ä¼˜å…ˆä¿è¯ï¼š
-- 1. æ•°æ®ä¸€è‡´æ€§ï¼ˆCï¼‰
-- 2. ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆAï¼‰
-- ç‰ºç‰²ï¼š
-- 3. åˆ†åŒºå®¹é”™æ€§ï¼ˆPï¼‰â†’ ä¸é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼

-- ä¾‹å­ï¼šé“¶è¡Œè½¬è´¦
-- å¿…é¡»ä¿è¯æ•°æ®å‡†ç¡®
-- å®å¯æš‚æ—¶ä¸å¯ç”¨ï¼Œä¹Ÿä¸èƒ½å‡ºé”™
```

---

## å®é™…å½±å“å’Œè§£å†³æ–¹æ¡ˆ

### å½±å“ 1ï¼šå¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´

**åœºæ™¯ï¼šç”µå•†åº“å­˜**

```javascript
// é—®é¢˜ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶ä¹°æœ€åä¸€ä»¶å•†å“
// ç”¨æˆ· A
const product = await db.products.findOne({ _id: 1 });
// stock = 1

// ç”¨æˆ· Bï¼ˆåŒæ—¶ï¼‰
const product = await db.products.findOne({ _id: 1 });
// stock = 1

// ç”¨æˆ· A è´­ä¹°
await db.products.updateOne({ _id: 1 }, { $inc: { stock: -1 } });
// stock = 0

// ç”¨æˆ· B è´­ä¹°
await db.products.updateOne({ _id: 1 }, { $inc: { stock: -1 } });
// stock = -1  âŒ è¶…å–äº†ï¼
```

**è§£å†³æ–¹æ¡ˆ 1ï¼šåŸå­æ“ä½œ**
```javascript
// âœ… ä½¿ç”¨åŸå­æ“ä½œ
const result = await db.products.updateOne(
  { _id: 1, stock: { $gt: 0 } },  // æ¡ä»¶ï¼šåº“å­˜ > 0
  { $inc: { stock: -1 } }
);

if (result.modifiedCount === 0) {
  throw new Error('åº“å­˜ä¸è¶³');
}
```

**è§£å†³æ–¹æ¡ˆ 2ï¼šä¹è§‚é”**
```javascript
// æ·»åŠ ç‰ˆæœ¬å·
{
  _id: 1,
  name: "iPhone",
  stock: 10,
  version: 1
}

// æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
const result = await db.products.updateOne(
  { _id: 1, version: 1, stock: { $gt: 0 } },
  { 
    $inc: { stock: -1, version: 1 }
  }
);

if (result.modifiedCount === 0) {
  // ç‰ˆæœ¬å·ä¸åŒ¹é…æˆ–åº“å­˜ä¸è¶³ï¼Œé‡è¯•
}
```

**è§£å†³æ–¹æ¡ˆ 3ï¼šä½¿ç”¨äº‹åŠ¡ï¼ˆMongoDB 4.0+ï¼‰**
```javascript
const session = client.startSession();
session.startTransaction();

try {
  const product = await db.products.findOne({ _id: 1 }, { session });
  
  if (product.stock > 0) {
    await db.products.updateOne(
      { _id: 1 },
      { $inc: { stock: -1 } },
      { session }
    );
    await db.orders.insertOne({ ... }, { session });
  }
  
  await session.commitTransaction();
} catch (error) {
  await session.abortTransaction();
  throw error;
}
```

---

### å½±å“ 2ï¼šæœ€ç»ˆä¸€è‡´æ€§

**åœºæ™¯ï¼šç¤¾äº¤ç½‘ç»œç‚¹èµ**

```javascript
// é—®é¢˜ï¼šæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹
// èŠ‚ç‚¹ 1ï¼šæ–‡ç« æ•°æ®
// èŠ‚ç‚¹ 2ï¼šç‚¹èµæ•°æ®
// èŠ‚ç‚¹ 3ï¼šç”¨æˆ·æ•°æ®

// ç”¨æˆ·ç‚¹èµ
await db.likes.insertOne({ userId: 1, postId: 1 });  // èŠ‚ç‚¹ 2
await db.posts.updateOne(
  { _id: 1 },
  { $inc: { likeCount: 1 } }
);  // èŠ‚ç‚¹ 1

// å¯èƒ½å‡ºç°ï¼š
// - èŠ‚ç‚¹ 2 æˆåŠŸï¼ŒèŠ‚ç‚¹ 1 å¤±è´¥ â†’ ç‚¹èµè®°å½•æœ‰ï¼Œä½†è®¡æ•°æ²¡åŠ 
// - èŠ‚ç‚¹ 1 æˆåŠŸï¼ŒèŠ‚ç‚¹ 2 å¤±è´¥ â†’ è®¡æ•°åŠ äº†ï¼Œä½†æ²¡æœ‰ç‚¹èµè®°å½•
// - ç½‘ç»œå»¶è¿Ÿ â†’ çŸ­æš‚ä¸ä¸€è‡´
```

**è§£å†³æ–¹æ¡ˆï¼šæ¥å—æœ€ç»ˆä¸€è‡´æ€§**
```javascript
// 1. å¼‚æ­¥è¡¥å¿
// å®šæ—¶ä»»åŠ¡æ£€æŸ¥å¹¶ä¿®å¤ä¸ä¸€è‡´

// 2. é‡è¯•æœºåˆ¶
async function likePost(userId, postId) {
  let retries = 3;
  while (retries > 0) {
    try {
      await db.likes.insertOne({ userId, postId });
      await db.posts.updateOne({ _id: postId }, { $inc: { likeCount: 1 } });
      break;
    } catch (error) {
      retries--;
      if (retries === 0) throw error;
      await sleep(1000);  // ç­‰å¾… 1 ç§’é‡è¯•
    }
  }
}

// 3. æ¶ˆæ¯é˜Ÿåˆ—
// ç‚¹èµ â†’ å‘é€æ¶ˆæ¯ â†’ å¼‚æ­¥å¤„ç†
await messageQueue.publish('like', { userId, postId });
```

---

### å½±å“ 3ï¼šæ— æ³•ä¿è¯å¤æ‚ä¸šåŠ¡é€»è¾‘

**åœºæ™¯ï¼šè®¢å•æ”¯ä»˜**

```javascript
// éœ€è¦ä¿è¯ï¼š
// 1. æ‰£å‡åº“å­˜
// 2. æ‰£æ¬¾
// 3. åˆ›å»ºè®¢å•
// 4. å¢åŠ ç§¯åˆ†
// å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥

// âŒ NoSQL å¾ˆéš¾ä¿è¯
await db.products.updateOne({ _id: 1 }, { $inc: { stock: -1 } });
await db.users.updateOne({ _id: 1 }, { $inc: { balance: -100 } });
await db.orders.insertOne({ ... });
await db.users.updateOne({ _id: 1 }, { $inc: { points: 10 } });
// ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå…¶ä»–æ­¥éª¤ä¸ä¼šå›æ»š
```

**è§£å†³æ–¹æ¡ˆï¼šæ··åˆä½¿ç”¨**
```javascript
// æ ¸å¿ƒä¸šåŠ¡ç”¨å…³ç³»å‹æ•°æ®åº“
// MySQL/PostgreSQL
BEGIN;
UPDATE products SET stock = stock - 1 WHERE id = 1;
UPDATE users SET balance = balance - 100 WHERE id = 1;
INSERT INTO orders ...;
UPDATE users SET points = points + 10 WHERE id = 1;
COMMIT;

// éæ ¸å¿ƒæ•°æ®ç”¨ NoSQL
// MongoDB
await db.logs.insertOne({ action: 'order_created', ... });
await db.analytics.updateOne({ ... });
```

---

## ä»€ä¹ˆæ—¶å€™ç”¨ NoSQLï¼Ÿ

### âœ… é€‚åˆç”¨ NoSQL

1. **æ—¥å¿—ç³»ç»Ÿ**
```javascript
// åªå†™å…¥ï¼Œä¸éœ€è¦äº‹åŠ¡
await db.logs.insertOne({
  level: 'info',
  message: 'User logged in',
  timestamp: new Date()
});
```

2. **ç¼“å­˜**
```javascript
// ä¸´æ—¶æ•°æ®ï¼Œä¸¢å¤±ä¹Ÿæ— æ‰€è°“
await db.cache.insertOne({
  key: 'user:1',
  value: { name: 'å¼ ä¸‰' },
  expireAt: new Date(Date.now() + 3600000)
});
```

3. **å®æ—¶åˆ†æ**
```javascript
// æµ·é‡æ•°æ®ï¼Œè¦æ±‚é«˜æ€§èƒ½
await db.events.insertOne({
  event: 'page_view',
  page: '/home',
  userId: 1
});
```

4. **ç¤¾äº¤ç½‘ç»œ**
```javascript
// æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—
await db.posts.insertOne({
  userId: 1,
  content: 'ä»Šå¤©å¤©æ°”ä¸é”™',
  likes: [],
  comments: []
});
```

### âŒ ä¸é€‚åˆç”¨ NoSQL

1. **é‡‘èç³»ç»Ÿ**
```javascript
// è½¬è´¦å¿…é¡»ä¿è¯ ACID
// ç”¨ MySQL/PostgreSQL
```

2. **ç”µå•†æ ¸å¿ƒä¸šåŠ¡**
```javascript
// è®¢å•ã€æ”¯ä»˜ã€åº“å­˜
// ç”¨ MySQL/PostgreSQL
```

3. **å¤æ‚å…³è”æŸ¥è¯¢**
```sql
-- éœ€è¦å¤šè¡¨ JOIN
-- ç”¨ MySQL/PostgreSQL
SELECT u.name, o.amount, p.name
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN products p ON o.product_id = p.id;
```

---

## æ€»ç»“

### NoSQL ä¸ºä»€ä¹ˆ ACID æ”¯æŒä¸å¥½ï¼Ÿ

1. **è®¾è®¡ç›®æ ‡ä¸åŒ**
   - ä¼˜å…ˆæ€§èƒ½å’Œæ‰©å±•æ€§
   - ç‰ºç‰²ä¸€è‡´æ€§

2. **åˆ†å¸ƒå¼æ¶æ„**
   - æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªèŠ‚ç‚¹
   - éš¾ä»¥ä¿è¯å¼ºä¸€è‡´æ€§

3. **CAP å®šç†**
   - é€‰æ‹© APï¼ˆå¯ç”¨æ€§ + åˆ†åŒºå®¹é”™ï¼‰
   - ç‰ºç‰² Cï¼ˆä¸€è‡´æ€§ï¼‰

### æƒè¡¡å–èˆ

| ç‰¹æ€§ | å…³ç³»å‹æ•°æ®åº“ | NoSQL |
|------|-------------|-------|
| ACID | å®Œæ•´æ”¯æŒ | éƒ¨åˆ†æ”¯æŒ |
| ä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ | æœ€ç»ˆä¸€è‡´æ€§ |
| æ€§èƒ½ | ä¸€èˆ¬ | é«˜ |
| æ‰©å±•æ€§ | å‚ç›´æ‰©å±• | æ°´å¹³æ‰©å±• |
| é€‚ç”¨åœºæ™¯ | é‡‘èã€ç”µå•† | æ—¥å¿—ã€åˆ†æ |

### é€‰æ‹©å»ºè®®

**æ ¸å¿ƒä¸šåŠ¡**ï¼š
- ç”¨å…³ç³»å‹æ•°æ®åº“ï¼ˆMySQL/PostgreSQLï¼‰
- ä¿è¯æ•°æ®å‡†ç¡®æ€§

**éæ ¸å¿ƒä¸šåŠ¡**ï¼š
- ç”¨ NoSQLï¼ˆMongoDB/Redisï¼‰
- æé«˜æ€§èƒ½å’Œæ‰©å±•æ€§

**æ··åˆä½¿ç”¨**ï¼š
```
å…³ç³»å‹æ•°æ®åº“ï¼ˆæ ¸å¿ƒï¼‰
  â†“
- ç”¨æˆ·ä¿¡æ¯
- è®¢å•æ•°æ®
- æ”¯ä»˜è®°å½•

NoSQLï¼ˆè¾…åŠ©ï¼‰
  â†“
- æ—¥å¿—
- ç¼“å­˜
- å®æ—¶æ•°æ®
```

---

## å¿«é€Ÿè®°å¿†

**ACID**ï¼š
- **A**tomicity - åŸå­æ€§ï¼ˆå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥ï¼‰
- **C**onsistency - ä¸€è‡´æ€§ï¼ˆæ•°æ®è§„åˆ™ä¸è¢«ç ´åï¼‰
- **I**solation - éš”ç¦»æ€§ï¼ˆå¹¶å‘æ“ä½œäº’ä¸å¹²æ‰°ï¼‰
- **D**urability - æŒä¹…æ€§ï¼ˆæäº¤åæ°¸ä¹…ä¿å­˜ï¼‰

**NoSQL çš„æƒè¡¡**ï¼š
- ç‰ºç‰²ï¼šå¼ºä¸€è‡´æ€§ã€å®Œæ•´äº‹åŠ¡
- æ¢å–ï¼šé«˜æ€§èƒ½ã€æ˜“æ‰©å±•ã€é«˜å¯ç”¨

**é€‰æ‹©åŸåˆ™**ï¼š
- é’±ç›¸å…³ â†’ å…³ç³»å‹
- æ€§èƒ½ç›¸å…³ â†’ NoSQL
- å¤æ‚å…³è” â†’ å…³ç³»å‹
- æµ·é‡æ•°æ® â†’ NoSQL

---

åŠ æ²¹ï¼ç†è§£äº†è¿™äº›æƒè¡¡ï¼Œä½ å°±èƒ½åšå‡ºæ­£ç¡®çš„æŠ€æœ¯é€‰æ‹©äº†ï¼ğŸ’ª
